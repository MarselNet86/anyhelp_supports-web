{% extends "main/base_dashboard.html" %} {% block dashboard_content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
  <!-- Header -->
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-2 flex items-center">
      <svg
        class="w-8 h-8 mr-3 text-brand-purple"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
        ></path>
      </svg>
      Импорт опор из Excel
    </h1>
    <p class="text-gray-600">
      Загрузите файл Excel для массового импорта данных об опорах ЛЭП
    </p>
  </div>

  <!-- Upload Form -->
  <div class="bg-white rounded-2xl p-8 shadow-lg border border-gray-200 mb-6">
    <form
      method="post"
      enctype="multipart/form-data"
      id="upload-form"
      class="space-y-6"
    >
      {% csrf_token %}

      <!-- File Upload Area -->
      <div
        class="border-2 border-dashed border-gray-300 rounded-2xl p-8 text-center hover:border-brand-purple transition-colors duration-300"
        id="drop-zone"
      >
        <svg
          class="w-16 h-16 mx-auto text-gray-400 mb-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          ></path>
        </svg>

        <div id="upload-content">
          <h3 class="text-lg font-semibold text-gray-900 mb-2">
            Перетащите Excel файл сюда
          </h3>
          <p class="text-gray-500 mb-4">или нажмите для выбора файла</p>
          <button
            type="button"
            class="btn bg-brand-purple hover:bg-purple-700 text-white rounded-xl px-6 py-2 transition-colors duration-200"
            onclick="document.getElementById('{{ form.file.id_for_label }}').click()"
          >
            <svg
              class="w-4 h-4 mr-2"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              ></path>
            </svg>
            Выбрать файл
          </button>
          {{ form.file }}
          <p class="text-xs text-gray-400 mt-2">
            Поддерживаются форматы: .xlsx, .xls (макс. 50MB)
          </p>
        </div>

        <!-- Selected file info -->
        <div id="file-info" class="hidden">
          <div class="flex items-center justify-center space-x-3">
            <svg
              class="w-8 h-8 text-green-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            <div>
              <p class="font-medium text-gray-900" id="file-name"></p>
              <p class="text-sm text-gray-500" id="file-size"></p>
            </div>
            <button
              type="button"
              onclick="clearFile()"
              class="text-red-500 hover:text-red-700"
            >
              <svg
                class="w-5 h-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Progress Bar (initially hidden) -->
      <div id="progress-container" class="hidden">
        <div class="mb-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-gray-700"
              >Прогресс загрузки</span
            >
            <span class="text-sm text-gray-500" id="progress-text">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div
              class="bg-gradient-to-r from-brand-purple to-brand-orange h-3 rounded-full transition-all duration-300 ease-out"
              id="progress-bar"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <!-- Processing status -->
        <div id="processing-status" class="hidden">
          <div class="flex items-center space-x-3 text-sm text-gray-600">
            <div
              class="loading loading-spinner loading-sm text-brand-purple"
            ></div>
            <span id="status-text">Обработка данных...</span>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-between items-center">
        <div class="text-sm text-gray-500">
          <svg
            class="w-4 h-4 inline mr-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          Убедитесь, что файл содержит правильные заголовки колонок
        </div>
        <button
          type="submit"
          id="submit-btn"
          class="btn bg-brand-orange hover:bg-orange-600 text-white rounded-xl px-8 py-3 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          <svg
            class="w-5 h-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            ></path>
          </svg>
          <span id="submit-text">Загрузить данные</span>
        </button>
      </div>
    </form>
  </div>
</div>

<style>
  .stat {
      @apply text-center;
  }
  .stat-figure {
      @apply flex justify-center mb-2;
  }
  .stat-title {
      @apply text-sm font-medium;
  }
  .stat-value {
      @apply text-2xl font-bold;
  }
  #{{ form.file.id_for_label }} {
      @apply sr-only;
  }
</style>

<script>
  let selectedFile = null;

  // Drag and drop functionality
  const dropZone = document.getElementById("drop-zone");
  const fileInput = document.getElementById("{{ form.file.id_for_label }}");
  const submitBtn = document.getElementById("submit-btn");
  const uploadForm = document.getElementById("upload-form");

  ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
    dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ["dragenter", "dragover"].forEach((eventName) => {
    dropZone.addEventListener(eventName, highlight, false);
  });

  ["dragleave", "drop"].forEach((eventName) => {
    dropZone.addEventListener(eventName, unhighlight, false);
  });

  function highlight(e) {
    dropZone.classList.add("border-brand-purple", "bg-purple-50");
  }

  function unhighlight(e) {
    dropZone.classList.remove("border-brand-purple", "bg-purple-50");
  }

  dropZone.addEventListener("drop", handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  }

  fileInput.addEventListener("change", function () {
    if (this.files.length > 0) {
      handleFile(this.files[0]);
    }
  });

  function handleFile(file) {
    if (!file.name.match(/\.(xlsx|xls)$/i)) {
      showMessage("Пожалуйста, выберите файл Excel (.xlsx или .xls)", "error");
      return;
    }

    if (file.size > 50 * 1024 * 1024) {
      // 50MB
      showMessage("Файл слишком большой. Максимальный размер: 50MB", "error");
      return;
    }

    selectedFile = file;
    showFileInfo(file);
    submitBtn.disabled = false;
  }

  function showFileInfo(file) {
    document.getElementById("upload-content").classList.add("hidden");
    document.getElementById("file-info").classList.remove("hidden");
    document.getElementById("file-name").textContent = file.name;
    document.getElementById("file-size").textContent = formatFileSize(
      file.size
    );
  }

  function clearFile() {
    selectedFile = null;
    fileInput.value = "";
    document.getElementById("upload-content").classList.remove("hidden");
    document.getElementById("file-info").classList.add("hidden");
    submitBtn.disabled = true;
    hideProgress();
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  function showProgress() {
    document.getElementById("progress-container").classList.remove("hidden");
  }

  function hideProgress() {
    document.getElementById("progress-container").classList.add("hidden");
    document.getElementById("progress-bar").style.width = "0%";
    document.getElementById("progress-text").textContent = "0%";
    document.getElementById("processing-status").classList.add("hidden");
  }

  function updateProgress(percent, statusText = "") {
    document.getElementById("progress-bar").style.width = percent + "%";
    document.getElementById("progress-text").textContent = percent + "%";

    if (statusText) {
      document.getElementById("processing-status").classList.remove("hidden");
      document.getElementById("status-text").textContent = statusText;
    }
  }

  function showMessage(message, type = "success") {
    const messagesContainer = document.getElementById("messages");

    const messageEl = document.createElement("div");
    messageEl.className = `alert ${
      type === "success" ? "alert-success" : "alert-error"
    } rounded-2xl`;

    const iconPath =
      type === "success"
        ? "M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
        : "M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z";

    messageEl.innerHTML = `
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}"></path>
            </svg>
            <span>${message}</span>
        `;

    messagesContainer.appendChild(messageEl);

    // Auto-hide after 5 seconds
    setTimeout(() => {
      messageEl.remove();
    }, 5000);
  }

  // Form submission with AJAX and progress
  uploadForm.addEventListener("submit", function (e) {
    e.preventDefault();

    if (!selectedFile) {
      showMessage("Пожалуйста, выберите файл для загрузки", "error");
      return;
    }

    const formData = new FormData(this);

    submitBtn.disabled = true;
    document.getElementById("submit-text").textContent = "Загружается...";
    showProgress();

    // Simulate upload progress
    let progress = 0;
    const progressInterval = setInterval(() => {
      progress += Math.random() * 10;
      if (progress > 85) progress = 85; // Stop at 85% until real response

      let statusText = "";
      if (progress < 30) statusText = "Загрузка файла...";
      else if (progress < 60) statusText = "Чтение данных...";
      else statusText = "Обработка строк...";

      updateProgress(Math.floor(progress), statusText);
    }, 200);

    // Actual AJAX request
    fetch(uploadForm.action, {
      method: "POST",
      body: formData,
      headers: {
        "X-Requested-With": "XMLHttpRequest",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        clearInterval(progressInterval);

        if (data.success) {
          // Complete progress
          updateProgress(100, "Сохранение в базу данных...");

          setTimeout(() => {
            // Update stats
            document.getElementById("created-count").textContent = data.created;
            document.getElementById("updated-count").textContent = data.updated;
            document.getElementById("total-count").textContent = data.total;

            showMessage(data.message, "success");

            if (data.errors && data.errors.length > 0) {
              showMessage(
                `Обработано с ошибками в ${data.errors.length} строках. Проверьте консоль для деталей.`,
                "error"
              );
              console.warn("Ошибки импорта:", data.errors);
            }

            hideProgress();
            clearFile();
          }, 1000);
        } else {
          showMessage(
            data.error || "Произошла ошибка при загрузке файла",
            "error"
          );
          hideProgress();
        }
      })
      .catch((error) => {
        clearInterval(progressInterval);
        console.error("Ошибка:", error);
        showMessage("Произошла ошибка при загрузке файла", "error");
        hideProgress();
      })
      .finally(() => {
        submitBtn.disabled = false;
        document.getElementById("submit-text").textContent = "Загрузить данные";
      });
  });
</script>
{% endblock %}
